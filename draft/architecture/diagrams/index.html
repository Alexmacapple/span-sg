<!DOCTYPE html>

<html class="writer-html5" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><link href="https://alexmacapple.github.io/span-sg/architecture/diagrams/" rel="canonical"/>
<link href="../../img/favicon.ico" rel="shortcut icon"/>
<title>Architecture - Diagrammes</title>
<link href="../../css/theme.css" rel="stylesheet"/>
<link href="../../css/theme_extra.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" rel="stylesheet"/>
<script>
        // Current page data
        var mkdocs_page_name = "Architecture - Diagrammes";
        var mkdocs_page_input_path = "architecture/diagrams.md";
        var mkdocs_page_url = "/span-sg/architecture/diagrams/";
      </script>
<!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
<link href="../../../exports/span-sg.pdf" rel="alternate" title="PDF" type="application/pdf"/></head>
<body class="wy-body-for-nav" role="document">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href="../..">
</a><div role="search">
<form action="../../search.html" class="wy-form" id="rtd-search-form" method="get">
<input aria-label="Search docs" name="q" placeholder="Search docs" title="Type search term here" type="text"/>
</form>
</div>
</div>
<div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../..">SPAN (SG)</a>
</li>
</ul>
<p class="caption"><span class="caption-text">SPAN (services)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules/bgs/">BGS</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/safi/">SAFI</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/siep/">SIEP</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/sircom/">SIRCOM</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/snum/">SNUM</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/srh/">SRH</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../synthese/">Synth√®se</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../processus/">Processus</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/">Guide contributeur</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../dev-local/">D√©veloppement local</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="" href="https://github.com/Alexmacapple/span-sg">Code source GitHub</a>
</li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
<nav aria-label="Mobile navigation menu" class="wy-nav-top" role="navigation">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="../.."></a>
</nav>
<div class="wy-nav-content">
<div class="rst-content"><div aria-label="breadcrumbs navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a aria-label="Docs" class="icon icon-home" href="../.."></a></li>
<li class="breadcrumb-item active">Architecture - Diagrammes</li>
<li class="wy-breadcrumbs-aside">
<a class="icon icon-github" href="https://github.com/Alexmacapple/span-sg/edit/master/docs/architecture/diagrams.md"> Edit on GitHub</a>
</li>
</ul>
<hr/>
</div>
<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div class="section" itemprop="articleBody">
<h1 id="architecture-diagrammes">Architecture - Diagrammes</h1>
<p>Repr√©sentations visuelles de l'architecture SPAN SG.</p>
<p>Version: 1.0.1-dsfr
Derni√®re mise √† jour: 2025-10-11</p>
<hr/>
<h2 id="1-cicd-pipeline">1. CI/CD Pipeline</h2>
<p>Pipeline complet GitHub Actions (draft + main).</p>
<pre><code class="language-mermaid">graph TD
    A[Push draft/main] --&gt; B{Branche?}

    B --&gt;|draft| C[Job: build-and-deploy-draft]
    B --&gt;|main| D[Job: build-and-deploy-main]

    C --&gt; E[Setup Python 3.11]
    D --&gt; E

    E --&gt; F[Install requirements-dsfr.txt]
    F --&gt; G[Install requirements-dev.txt]

    G --&gt; H[Black formatter check]
    H --&gt; I[Ruff linter]
    I --&gt; J[pytest unit tests]
    J --&gt; K[Coverage 89%+]

    K --&gt; L[Calculate SPAN scores]
    L --&gt; M[Build HTML DSFR&lt;br/&gt;mkdocs-dsfr.yml]

    M --&gt; N{Verify DSFR?}
    N --&gt;|‚ùå ReadTheDocs| O[FAIL]
    N --&gt;|‚úÖ data-fr-scheme| P[Install WeasyPrint deps]

    P --&gt; Q[Generate PDF&lt;br/&gt;--site-dir pdf-temp]
    Q --&gt; R[Enrich PDF metadata]
    R --&gt; S[Validate PDF qpdf]

    S --&gt; T{Branche?}
    T --&gt;|draft| U[Deploy draft/ on gh-pages]
    T --&gt;|main| V[Run E2E tests]

    V --&gt; W{E2E pass?}
    W --&gt;|‚ùå| X[Upload E2E report&lt;br/&gt;FAIL]
    W --&gt;|‚úÖ| Y[Deploy production on gh-pages]

    U --&gt; Z[‚úÖ Success]
    Y --&gt; Z

    style O fill:#ff6b6b
    style X fill:#ff6b6b
    style Z fill:#51cf66
</code></pre>
<p><strong>Validations:</strong> Black, Ruff, pytest, coverage 89%+, DSFR, PDF, E2E (main seulement)</p>
<p><strong>D√©ploiement:</strong>
- draft ‚Üí <code>gh-pages/draft/</code>
- main ‚Üí <code>gh-pages/</code> (racine)</p>
<hr/>
<h2 id="2-architecture-composants">2. Architecture Composants</h2>
<p>Structure projet et d√©pendances.</p>
<pre><code class="language-mermaid">graph TB
    subgraph "üìÅ docs/"
        A[modules/&lt;br/&gt;6 fichiers .md]
        B[synthese.md&lt;br/&gt;Tableau HTML DSFR]
        C[dev/&lt;br/&gt;API + Hooks Guide]
        D[adr/&lt;br/&gt;5 ADR]
        E[architecture/&lt;br/&gt;Diagrams]
    end

    subgraph "‚öôÔ∏è scripts/"
        F[calculate_scores.py&lt;br/&gt;100% coverage]
        G[enrich_pdf_metadata.py&lt;br/&gt;78% coverage]
    end

    subgraph "üîß hooks/"
        H[dsfr_table_wrapper.py&lt;br/&gt;100% coverage]
        I[title_cleaner.py&lt;br/&gt;100% coverage]
        J[pdf_copy.py&lt;br/&gt;0% coverage]
    end

    subgraph "‚úÖ tests/"
        K[test_hooks*.py&lt;br/&gt;13 tests]
        L[test_calculate_scores*.py&lt;br/&gt;26 tests]
        M[test_enrich_pdf*.py&lt;br/&gt;7 tests]
        N[e2e/&lt;br/&gt;9 sc√©narios]
    end

    subgraph "üèóÔ∏è Build"
        O[mkdocs-dsfr.yml&lt;br/&gt;HTML DSFR]
        P[mkdocs-dsfr-pdf.yml&lt;br/&gt;PDF ReadTheDocs]
    end

    subgraph "üì¶ Output"
        Q[site/&lt;br/&gt;HTML DSFR]
        R[pdf-temp/&lt;br/&gt;PDF temp]
        S[exports/&lt;br/&gt;span-sg.pdf]
    end

    A --&gt; F
    F --&gt; B
    B --&gt; O

    O --&gt; H
    O --&gt; I
    O --&gt; Q

    P --&gt; R
    R --&gt; G
    G --&gt; S

    K --&gt; H
    K --&gt; I
    L --&gt; F
    M --&gt; G

    style Q fill:#91d5ff
    style S fill:#ffc9c9
</code></pre>
<p><strong>Coverage global: 92%</strong> (seuil 89%+)</p>
<hr/>
<h2 id="3-workflow-git-branches">3. Workflow Git Branches</h2>
<p>Strat√©gie branching et releases.</p>
<pre><code class="language-mermaid">gitGraph
    commit id: "Initial"
    branch draft
    checkout draft
    commit id: "feat: SIRCOM"
    commit id: "feat: SNUM"

    checkout main
    merge draft tag: "v0.9.0"

    checkout draft
    commit id: "feat: DSFR theme"
    commit id: "fix: PDF isolation"
    commit id: "feat: hooks tests"
    commit id: "fix: E2E tests"
    commit id: "docs: API + ADR"

    checkout main
    merge draft tag: "v1.0.0"
</code></pre>
<p><strong>Branches:</strong>
- <code>main</code>: Production (GitHub Pages racine)
- <code>draft</code>: Preview (GitHub Pages /draft/)</p>
<p><strong>Tags:</strong> Releases officielles (v0.9.0, v1.0.0, v1.1.0, ...)</p>
<hr/>
<h2 id="4-architecture-hooks-dsfr">4. Architecture Hooks DSFR</h2>
<p>Cycle de vie hooks MkDocs.</p>
<pre><code class="language-mermaid">sequenceDiagram
    participant MD as Markdown
    participant MK as MkDocs
    participant DT as dsfr_table_wrapper
    participant TC as title_cleaner
    participant OUT as site/index.html

    Note over MD,MK: 1. Parsing Markdown
    MD-&gt;&gt;MK: *.md files
    MK-&gt;&gt;MK: Convert to HTML

    Note over MK,DT: 2. Hook: on_page_content
    MK-&gt;&gt;DT: html (tables sans wrapper)
    DT-&gt;&gt;DT: Regex: wrap &lt;table&gt;&lt;br/&gt;avec fr-table
    DT-&gt;&gt;MK: html (tables wrapp√©es)

    Note over MK: 3. G√©n√©ration layout
    MK-&gt;&gt;MK: Add &lt;head&gt;, footer, nav

    Note over MK,TC: 4. Hook: on_post_page
    MK-&gt;&gt;TC: output (titre avec tiret)
    TC-&gt;&gt;TC: Regex: clean "SPAN - "
    TC-&gt;&gt;MK: output (titre nettoy√©)

    Note over MK,OUT: 5. Write final HTML
    MK-&gt;&gt;OUT: HTML final DSFR
</code></pre>
<p><strong>Hooks:</strong>
1. <code>on_page_content</code>: Traite body HTML
2. <code>on_post_page</code>: Traite HTML complet</p>
<hr/>
<h2 id="5-coverage-tests-par-module">5. Coverage Tests par Module</h2>
<p>Distribution coverage actuelle.</p>
<pre><code class="language-mermaid">pie title "Coverage 92% (seuil 89%+)"
    "calculate_scores.py (100%)" : 72
    "enrich_pdf_metadata.py (78%)" : 39
    "dsfr_table_wrapper.py (100%)" : 9
    "title_cleaner.py (100%)" : 7
    "pdf_copy.py (0%)" : 11
</code></pre>
<p><strong>L√©gende:</strong>
- ‚úÖ Vert: 100% coverage (critiques)
- üü° Jaune: 78% coverage (acceptable)
- üî¥ Rouge: 0% coverage (v1.1)</p>
<p><strong>Total:</strong> 138 statements, 11 miss, <strong>92.03% coverage</strong></p>
<hr/>
<h2 id="6-deploiement-github-pages">6. D√©ploiement GitHub Pages</h2>
<p>Flow d√©ploiement dual (draft + production).</p>
<pre><code class="language-mermaid">flowchart LR
    subgraph "üîß CI Build"
        A[mkdocs build&lt;br/&gt;DSFR]
        B[Validate HTML&lt;br/&gt;data-fr-scheme]
        C[Generate PDF&lt;br/&gt;--site-dir pdf-temp]
    end

    subgraph "üåø Branches"
        D{Branche source?}
        E[draft]
        F[main]
    end

    subgraph "üì¶ gh-pages Branch"
        G[/draft/&lt;br/&gt;Preview]
        H[/ Racine&lt;br/&gt;Production]
    end

    subgraph "üåê GitHub Pages"
        I[alexmacapple.github.io/&lt;br/&gt;span-sg-repo/draft/]
        J[alexmacapple.github.io/&lt;br/&gt;span-sg-repo/]
    end

    A --&gt; B
    B --&gt; C
    C --&gt; D

    D --&gt;|draft push| E
    D --&gt;|main push| F

    E --&gt; G
    F --&gt; H

    G --&gt; I
    H --&gt; J

    style I fill:#91d5ff
    style J fill:#51cf66
</code></pre>
<p><strong>URLs:</strong>
- Draft: https://alexmacapple.github.io/span-sg-repo/draft/
- Production: https://alexmacapple.github.io/span-sg-repo/</p>
<p><strong>Strat√©gie:</strong> Git push direct (pas actions/deploy-pages, contr√¥le total)</p>
<hr/>
<h2 id="notes-techniques">Notes techniques</h2>
<h3 id="diagrammes-mermaid">Diagrammes Mermaid</h3>
<p>Les diagrammes sont renderis√©s automatiquement par MkDocs avec plugin <code>pymdownx.superfences</code>:</p>
<pre><code class="language-yaml"># mkdocs-dsfr.yml
markdown_extensions:
  - pymdownx.superfences:
      custom_fences:
        - name: mermaid
          class: mermaid
          format: !!python/name:pymdownx.superfences.fence_code_format
</code></pre>
<h3 id="modification-diagrammes">Modification diagrammes</h3>
<ol>
<li>√âditer ce fichier <code>docs/architecture/diagrams.md</code></li>
<li>Build local : <code>mkdocs serve --config-file mkdocs-dsfr.yml</code></li>
<li>V√©rifier render : http://localhost:8000/architecture/diagrams/</li>
<li>Commit si OK</li>
</ol>
<h3 id="syntaxe-mermaid">Syntaxe Mermaid</h3>
<ul>
<li><strong>Flowchart</strong>: <code>graph TB</code> (Top-Bottom) / <code>graph LR</code> (Left-Right)</li>
<li><strong>Sequence</strong>: <code>sequenceDiagram</code></li>
<li><strong>Pie chart</strong>: <code>pie title "..."</code></li>
<li><strong>Git graph</strong>: <code>gitGraph</code></li>
</ul>
<p>Documentation: https://mermaid.js.org/</p>
<hr/>
<h2 id="references">R√©f√©rences</h2>
<ul>
<li><a href="https://mermaid.js.org/">Mermaid Documentation</a></li>
<li><a href="https://squidfunk.github.io/mkdocs-material/reference/diagrams/">MkDocs Material - Diagrams</a></li>
<li>Architecture Decision Records: <a href="../../adr/">docs/adr/</a></li>
<li>API Reference: <a href="../../dev/api-reference/">docs/dev/api-reference.md</a></li>
</ul>
</div>
</div><footer>
<hr/>
<div role="contentinfo">
<!-- Copyright etc -->
</div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
</div>
</div>
</section>
</div>
<div aria-label="Versions" class="rst-versions" role="note">
<span class="rst-current-version" data-toggle="rst-current-version">
<span>
<a class="fa fa-github" href="https://github.com/Alexmacapple/span-sg" style="color: #fcfcfc"> GitHub</a>
</span>
</span>
</div>
<script src="../../js/jquery-3.6.0.min.js"></script>
<script>var base_url = "../..";</script>
<script src="../../js/theme_extra.js"></script>
<script src="../../js/theme.js"></script>
<script src="../../search/main.js"></script>
<script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>
</body>
</html>
